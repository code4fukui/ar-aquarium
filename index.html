<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" href="data:">
<title>AR Aquarium</title>
</head>
<body>

<div id="info">
	<h1>AR Aquarium (AR水族館)</h1>
	DATA: <a href="./fishes.csv">CSVオープンデータ by Code for FUKUI (こどもシビックテック)</a><br>
	LIB: <a href="https://threejs.org">three.js</a><br>
	APP: <a href="https://github.com/ar-aquarium/">src on GitHub</a><br>
</div>

<style>
body {
	margin: 0;
	background-color: #eee;
	font-family: sans-serif;
}
#info {
	position: absolute;
	background-color: rgba(155, 155, 155, 0.5);
	padding: 0.5em;
	margin: 0.5em;
	color: #111;
}
a {
	color: #228 !important;
}
#ARButton {
	color: black !important;
	border: 1px solid black !important;
}
</style>

<!-- Import maps polyfill -->
<!-- Remove this when import maps will be widely supported -->
<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

<script type="importmap">
{
	"imports": {
		"three": "https://code4fukui.github.io/three.js/build/three.module.js",
		"three/addons/": "https://code4fukui.github.io/three.js/examples/jsm/"
	}
}
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js"; // for PC
import { ARButton } from "three/addons/webxr/ARButton.js";
import { CSV } from "https://js.sabae.cc/CSV.js";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
//renderer.outputEncoding = THREE.sRGBEncoding;
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

// XRボタン追加
document.body.appendChild(ARButton.createButton(renderer));

// ブラウザのリサイズに対応
addEventListener("resize", () => {
	camera.aspect = innerWidth / innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(innerWidth, innerHeight);
}, false);

// ライティング
const ambientLight = new THREE.AmbientLight(0xcccccc, 0.4);
scene.add(ambientLight);

const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
directionalLight.position.set(0, 0, 1);
scene.add(directionalLight);

// fishes
const fishesdata = await CSV.fetchJSON("./fishes.csv");

const makeFish = (options) => {
	// テクスチャー読み込み
	const textureLoader = new THREE.TextureLoader();
	const texture = textureLoader.load(options.file);
	const fish1aspect = options.height / options.width;
	
	// 平面ジオメトリの生成
	const sw = 8;
	const size = options.size;
	const planeGeometry = new THREE.PlaneGeometry(size, size * fish1aspect, sw, 1);
	const material = new THREE.MeshBasicMaterial({
		map: texture,
		transparent: true,
		side: THREE.DoubleSide,
		//color: 0xFF0000, wireframe: true,
	});
	const mesh = new THREE.Mesh(planeGeometry, material);
	mesh.animate = (t) => {
		// メッシュのジオメトリをリアルタイムで変更
		const p = mesh.geometry.attributes.position;
		const a = p.array;
		for (let i = 0; i <= sw; i++) {
			const z = Math.cos(t / 100 + i * options.freq) * options.amp;
			a[2 + i * 3] = z;
			a[2 + i * 3 + (sw + 1) * 3] = z;
		}
		p.needsUpdate = true;

		// 場所設定
		const th = mesh.th + t * options.speed;
		mesh.position.x = Math.cos(th) * mesh.r;
		mesh.position.z = Math.sin(th) * mesh.r;
		mesh.rotation.y = Math.atan2(mesh.position.x, mesh.position.z) - Math.PI;
	};
	return mesh;
};

const fishes = [];
for (let i = 0; i < 30; i++) {
	const d = fishesdata[i % fishesdata.length];
	const fish = makeFish(d);
	scene.add(fish);
	fish.position.y = Math.random() * 1 + .5;
	fish.r = Math.random() * 3 + .5;
	fish.th = Math.random() * Math.PI * 2;
	fishes.push(fish);
}

// アニメーション
const t0 = performance.now();
const animate = () => {
	const t = t0 - performance.now();

	for (const fish of fishes) {
		fish.animate(t);
	}

	renderer.render(scene, camera);
};
renderer.setAnimationLoop(animate);

</script>
</body>
</html>
